<!DOCTYPE html>
<html>
  <head>
    <title>Preview.vim</title>
  </head>
  <style id="_base_theme"></style>
  <link id="_highlightjs_theme" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.3.1/highlight.min.js"></script>
  <body>
    <div id="content">
      <h1>Preview.vim</h1>
    </div>
    <script>
      async function connect_ws() {
        let ws = new WebSocket("ws://localhost:8080");
        ws.onopen = (event) => {
          ws.send(
            JSON.stringify({ type: "notification", msg: "browser_is_ready" })
          );
        };
        ws.onmessage = (event) => {
          let data = JSON.parse(event.data);
          switch (data.type) {
            case "show":
              document.getElementById("content").innerHTML = data.msg;
              hljs.highlightAll();
              break;
            case "cur_pos":
              console.log(data.msg);
              document
                .getElementById("line_num_" + data.msg.toString())
                .scrollIntoView({ block: "center" });
              break;
            case "theme_has_changed":
              location.reload();
              break;
            default:
          }
        };
        ws.onerror = function (err) {
          console.error(
            "Socket encountered error: ",
            err.message,
            "Closing socket"
          );
          ws.close();
        };
        ws.onclose = (event) => {
          document.getElementById("content").innerHTML =
            "<h1>Connection Closed ... </h1>" +
            "<h1>Waiting For another instance</h1>";
          setTimeout(function () {
            connect_ws();
          }, 500);
        };
      }
      connect_ws();
    </script>
  </body>
</html>
